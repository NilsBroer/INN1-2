<!DOCTYPE html>

<meta charset="UTF-8">
<!-----------------------------------BOOTSTRAP------------------------------------------------------------------------->
<link rel="stylesheet" href="css/bootstrap.min.css">
<script src="js/bootstrap.min.js"></script>
<!--------------------------------------------------------------------------------------------------------------------->
<!-- ! SMART CONTRACT ABI !  -->
<!----------------------------->
<script>
ABI = [
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "id",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			}
		],
		"name": "activateParty",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "adr",
				"type": "address"
			}
		],
		"name": "activateStudent",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "moderator",
				"type": "address"
			}
		],
		"name": "addModerator",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "administrator",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "id",
				"type": "string"
			}
		],
		"name": "deactivateParty",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "adr",
				"type": "address"
			}
		],
		"name": "deactivateStudent",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "id",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			}
		],
		"name": "editPartyName",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "evaluate",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "moderators",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "p_i",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "parties",
		"outputs": [
			{
				"internalType": "string",
				"name": "id",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "votes",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "active",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "reset",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "partyId",
				"type": "string"
			}
		],
		"name": "vote",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
]
</script>

<!--------------------------------------------------------------------------------------------------------------------->
<!-- ! CSS !  -->
<!-------------->

<style>
	/*Media Querys:*/
	@media (max-width: 840px)
	{
		.vDynamicSideMargin {
			margin-right: 0%;
			margin-left: 0%;
		}
		.vDynamicWidth {
			width: 95%
		}
	}
	/*---*/
	@media (min-width: 840px)
	{
		.vDynamicSideMargin {
			margin-right: 7%;
			margin-left: 7%;
		}
		.vDynamicWidth {
			width: 90%
		}
	}
	/*---*/
	@media (min-width: 1041px)
	{
		.vDynamicSideMargin {
			margin-right: 13%;
			margin-left: 13%;
		}
		.vDynamicWidth {
			width: 80%
		}
	}
	/*---*/
	@media (min-width: 1440px)
	{
		.DynamicSideMargin {
			margin-right: 17%;
			margin-left: 17%;
		}
		.vDynamicWidth {
			width: 66%
		}
	}
	/*---*/
	@media (min-width: 2000px) {
		.vDynamicSideMargin {
			margin-right: 28%;
			margin-left: 28%;
		}
		.vDynamicWidth {
			width: 50%
		}
	}
	/*---*/

	.vCanvas {
		-webkit-box-shadow: inset 0px 0px 18px -6px rgba(0,0,0,1);
		-moz-box-shadow: inset 0px 0px 18px -6px rgba(0,0,0,1);
		box-shadow: inset 0px 0px 18px -6px rgba(0,0,0,1);
		padding: 1em;
		margin: 0.25em;
		display: inline-block;
		font-family: Arial, Helvetica, sans-serif;
	}
	.vInfo {
		width:95%;
		margin: 0.5em;
		padding: 0.333em;
		border: 0.0333em solid black;
		background-color: white;
		border-radius: 0.25em;
		display: inline-block
	}
	.vLog {
		margin-left: auto;
		margin-right: auto;
		margin-bottom: 0.333em;
		padding: 0.44444em;
		border: 0.033333em solid black;
		background-color: #a3ffe0;
		border-radius: 0.5em;
		color: black;
		display: block
	}
	.vWrapper {
		overflow: hidden;
		margin: 0.25em;
		padding: 0.66666em;
		background-color: lightblue;
		color: black;
		align-content: center;
	}
	.vWrapper input, select{
		width: 100%;
		margin: 0.4444444em;
		padding: 0.222222em;
		
	}
	.vWrapper button {
	  background-color: lightgreen;
	  border-radius: 0.25em;
	  color: black;
	  margin: 0.444444em;
	  padding: 0.44444em;
	  text-align: center;
	  text-decoration: none;
	  display: inline-block;
	  font-size: 16px;
	}
	.vWrapper button :hover {
	  background-color: #4CAF50;
	  color: white;
	}
	.vShadow {
		-webkit-box-shadow: 0px 0px 6px -2px rgba(0,0,0,1);
		-moz-box-shadow: 0px 0px 6px -2px rgba(0,0,0,1);
		box-shadow: 0px 0px 6px -2px rgba(0,0,0,1);
	}
	.vLine{
		border-bottom: 0.055555em solid black;
		width: 100%; height: 0.1em;
		display: block;
	}
</style>

<!--------------------------------------------------------------------------------------------------------------------->
<!-- ! HTML !  -->
<!--------------->

<div class="vDynamicSideMargin">
	<div class="vCanvas">
		<div style="text-align: center;">
			<a onclick="switchGerman()" href="javascript:void(0);">Deutsch</a>
			<a onclick="switchEnglish()" href="javascript:void(0);">English</a>
		</div>
		<div class="vWrapper">
			<div class="vInfo vShadow" id="info_field">
			</div>
			<button onclick="connect()" id="begin_button" class="vShadow">BEGIN</button></br>
		</div>
		<div id="configuration_box" class="vWrapper" style="display: none;">
			<div class="container-fluid">
				<div class="row">
					<div class="col-sm-12 col-md-12 col-lg-12">
						<span>Node: </span>
						<select id="node_selector">
							<option value="https://mainnet.infura.io/v3/4e8efa5c183249169020ef5302bdb10e">
								Main Net (infura API)
							</option>
							<option value="https://rinkeby.infura.io/v3/4e8efa5c183249169020ef5302bdb10e">
								Rinkeby Test-Net (infura API)
							</option>
						</select>
						</br>
					</div>
					<div class="col-sm-12 col-md-6 col-lg-5">
						<span>Address:</span>
						<select id="address_selector">
							<option value="" id="select_address_option_field">
								Select an address!
							</option>
						</select>
						<input id="address_input" placeholder="Your ethereum address">
						<script>
							let select = document.querySelector('#address_selector');
							select.addEventListener('change',function(){
								document.getElementById("address_input").value = select.options[select.selectedIndex].value;
							});
						</script>
					</div>
					<div class="col-sm-12 col-md-6 col-lg-5">
						<span>Contract:</span>
						<select id="contract_selector">
							<option value="" id="select_contract_option_field">
								Select a contract!
							</option>
							<option value="0x60a7B9353086D670F6459218e377F6C31B1d43DC">
								1: 0x60a7B9353086D670F6459218e377F6C31B1d43DC
							</option>
							<option value="0xD70b97f75b4c371d44Db05a116EcAF67Dd9a8355">
								2: 0xD70b97f75b4c371d44Db05a116EcAF67Dd9a8355
							</option>
						</select>
						<input id="contract_input" placeholder="Vote contract address">
						<script>
							let contractSelect = document.querySelector('#contract_selector');
							contractSelect.addEventListener('change',function(){
								document.getElementById("contract_input").value =
										contractSelect.options[contractSelect.selectedIndex].value;
							});
						</script>
					</div>
					<div class="col-sm-12 col-md-12 col-lg-2">
						<button onclick="connectToContract()" id="connect_button" class="vShadow">CONNECT</button></br>
						<button onclick="clearHistory()" id="clear_button" class="vShadow">CLEAR</button>
					</div>
				</div>
			</div>
		</div>
		<div id="history_box" class="vWrapper" style="display: none">
			<b id="history_label">History:</b></br>
			<div id="info_box" class="vLog vShadow vDynamicWidth"></div>
		</div>
	</div>
</div>

<!--------------------------------------------------------------------------------------------------------------------->
<!-- ! CODE !  -->
<!--------------->

<script src="https://cdn.jsdelivr.net/npm/web3@1.2.6/dist/web3.min.js"></script>
<script>
	async function sleep(ms) { // Utility function to await contract results...
		await new Promise(resolve => setTimeout(resolve, ms));
	}

	let _lang = "en"

	window.onload = function() {
		if ( _lang === "en" ) switchEnglish();
		else switchGerman();
	};

	function log(m){ document.getElementById("info_box").innerHTML += ('</br><div class="vInfo vShadow">'+String(m).replace("\n", "</br>")+'</div>'); }
	function logLine(){ document.getElementById("info_box").innerHTML += '</br><span class="vLine"></span>'; }
	function clearHistory(){document.getElementById("info_box").innerHTML="";}

	function switchEnglish()
	{
		_lang = "en"
		document.getElementById("history_label").innerText = "History";
		document.getElementById("info_field").innerHTML = 
			"Info:".bold()+
			"</br></br>"+
				"Welcome to the FH-Voting Blockchain Interface!"+
			"</br></br>"+
				"In the Dropdown-Menu below, you may choose which Blockchain-Network you wish to connect to. The options are either our Main Network, or the Test-Network based on Rinkeby."+
			"</br></br>"+
				"In the next field, enter the ethereum address which has been assigned to you. This is your identity with which you will cast your vote. "+
			"</br></br>"+
				"The last field takes the address of the Voting-Contract. This address can be found below, make sure you verify that it is indeed correct!"+
			"</br></br>"+
			"Contract Addresses:".bold()+
			"</br></br>";

		document.getElementById("connect_button").textContent = "CONNECT";
		document.getElementById("clear_button").textContent = "CLEAR";
		document.getElementById("address_input").placeholder = "Your ethereum address";
		document.getElementById("contract_input").placeholder = "Vote contract address";
		document.getElementById("begin_button").textContent = "GOT IT!";
		document.getElementById("select_address_option_field").textContent = "Select an address!"
		document.getElementById("select_contract_option_field").textContent = "Select a contract!"
	}

	function switchGerman()
	{
		_lang = "de"
		document.getElementById("history_label").innerText = "Verlauf";
		document.getElementById("info_field").innerHTML = 
			"Info:".bold()+
			"</br></br>"+
				"Wilkommen im FH-Voting Blockchain Interface!"+
			"</br></br>"+
				"Im Menü unterhalb wählen Sie, auf welcher Blockchain Sie abstimmen möchten. Die Optionen sind entweder das Hauptnetzwerk, oder das Rinkeby-Testnetzwerk."+
			"</br></br>"+
				"Darunter geben Sie die Ihnen zugeteilte Ethereum-Adresse ein. Diese repräsentiert Ihre Identität mit welcher Sie Ihre Stimme abgeben."+
			"</br></br>"+
				"Im letzten Feld geben Sie die Adresse des Wahl-Contracts ein, bitte überprüfen Sie dessen Richtigkeit!"+
			"</br></br>"+
			"Contract Adressen:".bold()+
			"</br></br>";
		
		document.getElementById("connect_button").textContent = "VERBINDEN";
		document.getElementById("clear_button").textContent = "VERLAUF LÖSCHEN";
		document.getElementById("address_input").placeholder = "Ihre Ethereum Adresse";
		document.getElementById("contract_input").placeholder = "Wahl-Contract Adresse";
		document.getElementById("begin_button").textContent = "VERSTANDEN!";
		document.getElementById("select_address_option_field").textContent = "Wählen Sie eine Adresse!"
		document.getElementById("select_contract_option_field").textContent = "Wählen Sie einen Contract!"
	}

	function _l(versions){
		switch(_lang) {
			case "en": return versions[0]
			case "de": return versions[1]
		}
	}

	// Backend :

	let _contract = null;
	let _web3 = null;
	let _administrator = null;
	let _user = null;
	let _userIsAdmin = false;
	let _userAccounts = [];

	function connect() {
		// Getting web3 connection instance:
		_web3 = getWeb3Connection();
		// Getting all accounts of the user:
		_web3.eth.getAccounts((err, res) => {_userAccounts.push(res);});
		// After some time (for account query) connect to contract:
		setTimeout(function (){
				// Optional: Clear all existing options first:
				let select = document.getElementById("address_selector");
				//select.innerHTML = "";
				// Populate list with options:
				for(var i=0; i < _userAccounts.length; i++) select.innerHTML +=
						"<option value=\"" + _userAccounts[i] + "\">Account "+i+" : " + _userAccounts[i] + "</option>";

				document.getElementById("configuration_box").style.display = '';
				document.getElementById("begin_button").style.display = 'none';
				document.getElementById("history_box").style.display = '';

		}, 1000);
	}

	function connectToContract()
	{
		var errorOccurred = false;
		if(document.getElementById("contract_input").value.trim()===""){
			log(`
			<b style="color: #A00000">
				`+_l([
						"ERROR! Please enter the voting contract address!",
						"FEHLER! Bitte geben Sie die Contract-Adresse ein."
				])+`
			</b></br>
			`)
			errorOccurred = true;
		}
		if (document.getElementById("address_input").value.trim()==="") {
			log(`
			<b style="color: #A00000">
				`+_l([
						"ERROR! Please enter your address!",
						"FEHLER! Bitte geben Sie Ihre Ethereum-Adresse ein."
					])+`
			</b></br>
			`)
			errorOccurred = true;
		}

		if ( errorOccurred ) return;

		try {
			_contract = new web3.eth.Contract(ABI, document.getElementById("contract_input").value.trim());// Takes API and address
		} catch (e) {
			log(`
			<b style="color: #A00000">
				`+_l([
				"ERROR! Failed to connect to contract!</br>Message :</br> '"+e+"'",
				"Fehler! Verbindung zum Contract ist fehlgeschlagen!</br>Nachricht :</br> '"+e+"'"
			])+`
			</b></br>
			`);
			errorOccurred = true;
		}
		if ( _contract != null && !errorOccurred ) {
			log(_l([
				"Connection established successfully!",
				"Verbindung erfolgreich hergestellt!"
			]));
		}

		_contract.methods.administrator().call()
			.then( val => {
				_administrator = val;
				_user = document.getElementById("address_input").value.trim();
				_userIsAdmin = _user === _administrator;
				if ( _userIsAdmin ) {
					log(_l([
						"Hello administrator!",
						"Hallo Administrator!"
					]));
				} else {
					log(_l([
						"The administrator of this contract is : "+_administrator,
						"Der Administrator dieses Contracts ist : "+_administrator
					]));
				}
				if (!errorOccurred)
				{
					let partyOptionList = [];
					let partyInfoList = [];
					let i = 0;
					let trials = 10
					while ( !errorOccurred && i < 10 ) {

						_contract.methods.p_i(i).call()
								.then(partyIndex => {
									console.log(i+". party, index : '" + partyIndex+"';");
									_contract.methods.parties(partyIndex).call() // WHY IS THIS NOT WORKING?
											.then( party => {
												trials--;
												console.log(i+" party, index : '"+partyIndex+"'; name : '" + party.name+"';");
												if ( partyIndex !== "" ) {
													partyOptionList.push(
															'<option value="' + partyIndex + '">' + party.name + '</option>'
													);
													partyInfoList.push(
															_l(['Party', 'Partei']) + " " +
															party.id + " - " +
															party.name + " : " +
															party.votes + _l([' votes, ', ' Stimmen, ']) +
															_l(['active : ', 'Aktiv : ']) + party.active
													);
												}
											})
											.catch( err => {
												log(err.message);
												errorOccurred=true;
											} );
								})
								.catch( err => {
									log(err.message);
									errorOccurred=true;
								});
						console.log('Trying to find party at index '+i+'; Sleeping a little...')
						sleep(3000);
						i ++;
					}
					if ( errorOccurred ) log(
							[
									'<b style="color: #A00000">ERROR! Party loading failed.</b>',
									'<b style=\"color: #A00000\">FEHLER! Parteien konnten nicht geladen werden.</b>'
							]
					);
					else {
						console.log('Waiting for trials to finish! ' + trials + ' running...')
						log(_l(["Loading parties...", "Parteien werden geladen..."]));
						setTimeout(
								function () {
									if (trials === 0)
										log(_l([
											'Loading trials successful!',
											'Lade Versuche erfolgreich!'
										]))
									else {
										log(_l([
											'<b style="color: #A00000">ERROR! Unfinished loading trials : '+trials+'.</b>',
											'<b style="color: #A00000">Fehler! Unvollständige Ladeversuche : '+trials+'.</b>'
										]));
										return;
									}
									let options = partyOptionList.join("");
									let info = partyInfoList.join("<br>");

									log(_l(["Your choice", "Ihre Wahl:"]) + `: </br>
										<div style="margin-right: 1em;">
											<select id = "PartySelector">
												` + options + `
											</select>
											<button onclick="submitVote()" style="float: right;">` + _l(["SUBMIT VOTE", "ABSTIMMEN"]) + `</button>
											<div class="vInfo">
												` + info + `
											</div>
										</div>
									`);
								},
								5000
						);
					}
				}
			})
			.catch(
					err => {
						log(`
							<b style="color: #A00000">
							`+_l([
									"ERROR! Failed to fetch administrator address from contract!</br>Message :</br> '"+err.message+"'",
									"Fehler! Administrator Addresse nicht abrufbar!</br>Nachricht :</br> '"+err.message+"'"
								])+`
							</b></br>
						`);
					}
			);

	}
	
	function submitVote()
	{
		var selector = document.getElementById("PartySelector");
		var party = selector.options[selector.selectedIndex].value.trim();
		var partyString = selector.options[selector.selectedIndex].text.trim();
		var partyIndex = selector.options[selector.selectedIndex].value.trim();
		var address = document.getElementById("address_input").value.trim();
		var verify = confirm(
				_l([
					"Casting your vote is final. Do you wish to vote for " + partyString + "?",
					"Ihre Stimme lässt sich hinterher nicht mehr ändern. Stimmen Sie für " + partyString + "?"
				])
		);

		if (!verify) { return; } // VERIFICATION!

		//log(_l(["...establishing contract connection...", "...Verbindung mit dem Contract wird hergestellt..."]));

		var contract = _contract; //new web3.eth.Contract(ABI, document.getElementById("contract_input").value.trim());// Takes API and address

		log(_l(["...sending vote...", "...Stimme wird abgegeben..."]));
		//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		contract.methods.vote(partyIndex)
			.send({from: address}, function(error, transactionHash){ log(error) } )
			.then( val => {
				log(_l(["Success!", "Erfolg!"]));
				// Check how many votes:
				log(_l(["Number of votes for your party:","Anzahl der Stimmen für Ihre Partei:"])+"<br>");
				contract.methods.parties(partyIndex).call()
						.then( party => log(party.votes) )
						.catch( err => log(err.message) );
			});
		//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


	}
	
	function getWeb3Connection()
	{
		log(_l(["...getting web3.js instance...", "...web3.js Instanz wird aufbereitet..."]))
		var web3
		if(window.web3==="legacy"){
			log(_l([
					"WARNING: Legacy mode detected! Please switch to neweset MetaMask version!",
				"ACTHUNG: Sie befinden sich im Legacy-Modus! Bitte wechseln Sie zur neusten MetaMask Version!"
			]))
			var selector = document.getElementById("node_selector");
			var rpcURL = selector.options[selector.selectedIndex].value;
			web3 = new Web3(new Web3.providers.HttpProvider(rpcURL))
		} else {
			web3 = window.web3;
		}
		return web3;
	}

	window.addEventListener('load', async () => {
		if (window.ethereum) {// Modern dapp browsers...
			window.web3 = new Web3(ethereum);
			try { // Request account access if needed
				await ethereum.enable();// Acccounts now exposed
			} catch (error) {
				alert(_l([
						"Account access denied! :(",
						"Account Zugriff verwehrt! :("
				]));// User denied account access...
			}
		} else if (window.web3) {// Legacy :
			alert(_l([
					'Legacy browser detected. You should consider trying newest version of MetaMask!',
					'Veralteter Browser erkannt. Probieren Sie die neuste MetaMask version!'
			]));
			window.web3 = "legacy"
		} else { // Full legacy : (Never go full legacy)
			alert(_l([
					'Non-Ethereum browser detected. You should consider trying MetaMask!',
					'Ethereum inkompatibler Browser erkannt! Probieren Sie MetaMask!'
			]));
		}
	});

</script>
		




