<!DOCTYPE html>

<meta charset="UTF-8">
<!--------------------------------------------------------------------------------------------------------------------->
<!-- ! SMART CONTRACT ABI !  -->
<!----------------------------->
<script>
ABI = [
		{
			"inputs": [
				{"internalType": "string", "name": "id", "type": "string"},
				{"internalType": "string", "name": "name", "type": "string"}
			],
			"name": "activateParty",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [{"internalType": "address", "name": "adr", "type": "address"}],
			"name": "activateStudent",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [{"internalType": "address", "name": "moderator", "type": "address"}],
			"name": "addModerator",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [{"internalType": "string", "name": "id", "type": "string"}],
			"name": "deactivateParty",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [{"internalType": "address", "name": "adr", "type": "address"}],
			"name": "deactivateStudent",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [
				{"internalType": "string", "name": "id", "type": "string"},
				{"internalType": "string", "name": "name", "type": "string"}
			],
			"name": "editPartyName",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "reset",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [{"internalType": "string", "name": "partyId", "type": "string"}],
			"name": "vote",
			"outputs": [],
			"stateMutability": "nonpayable",
			"type": "function"
		},
		{
			"inputs": [],
			"stateMutability": "nonpayable",
			"type": "constructor"
		},
		{
			"inputs": [],
			"name": "administrator",
			"outputs": [{"internalType": "address", "name": "", "type": "address"}],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [],
			"name": "evaluate",
			"outputs": [{"internalType": "string", "name": "", "type": "string"}],
			"stateMutability": "view",
			"type": "function"
		},
		{
			"inputs": [{"internalType": "address", "name": "", "type": "address"}],
			"name": "moderators",
			"outputs": [{"internalType": "address", "name": "", "type": "address"}],
			"stateMutability": "view", "type": "function"
		},
		{
			"inputs": [{"internalType": "string", "name": "", "type": "string"}],
			"name": "parties",
			"outputs": [
				{"internalType": "string", "name": "id", "type": "string"},
				{"internalType": "string", "name": "name", "type": "string"},
				{"internalType": "uint256", "name": "votes", "type": "uint256"},
				{"internalType": "bool", "name": "active", "type": "bool"}
			],
			"stateMutability": "view", "type": "function"
		}
]
</script>

<!--------------------------------------------------------------------------------------------------------------------->
<!-- ! CSS !  -->
<!-------------->

<style>
	/*Media Querys:*/
	@media (max-width: 840px)
	{
		.vDynamicSideMargin {
			margin-right: 0%;
			margin-left: 0%;
		}
		.vDynamicWidth {
			width: 100%
		}
	}
	/*---*/
	@media (min-width: 840px)
	{
		.vDynamicSideMargin {
			margin-right: 7%;
			margin-left: 7%;
		}
		.vDynamicWidth {
			width: 90%
		}
	}
	/*---*/
	@media (min-width: 1041px)
	{
		.vDynamicSideMargin {
			margin-right: 13%;
			margin-left: 13%;
		}
		.vDynamicWidth {
			width: 80%
		}
	}
	/*---*/
	@media (min-width: 1440px)
	{
		.DynamicSideMargin {
			margin-right: 17%;
			margin-left: 17%;
		}
		.vDynamicWidth {
			width: 66%
		}
	}
	/*---*/
	@media (min-width: 2000px) {
		.vDynamicSideMargin {
			margin-right: 28%;
			margin-left: 28%;
		}
		.vDynamicWidth {
			width: 50%
		}
	}
	/*---*/

	.vCanvas {
		-webkit-box-shadow: inset 0px 0px 18px -6px rgba(0,0,0,1);
		-moz-box-shadow: inset 0px 0px 18px -6px rgba(0,0,0,1);
		box-shadow: inset 0px 0px 18px -6px rgba(0,0,0,1);
		padding: 1em;
		margin: 0.25em;
		display: inline-block;
		font-family: Arial, Helvetica, sans-serif;
	}
	.vInfo {
		width:95%;
		margin: 0.5em;
		padding: 0.333em;
		border: 0.0333em solid black;
		background-color: white;
		border-radius: 0.25em;
		display: inline-block
	}
	.vLog {
		margin: 0.333em;
		padding: 0.44444em;
		border: 0.033333em solid black;
		background-color: #a3ffe0;
		border-radius: 0.5em;
		color: black;
		display: inline-block
	}
	.vWrapper {
		overflow: hidden;
		margin: 0.25em;
		padding: 0.66666em;
		background-color: lightblue;
		color: black;
		align-content: center;
	}
	.vWrapper input, select{
		width: 100%;
		margin: 0.4444444em;
		padding: 0.222222em;
		
	}
	.vWrapper button {
	  background-color: lightgreen;
	  border-radius: 0.25em;
	  color: black;
	  margin: 0.444444em;
	  padding: 0.44444em;
	  text-align: center;
	  text-decoration: none;
	  display: inline-block;
	  font-size: 16px;
	}
	.vWrapper button :hover {
	  background-color: #4CAF50;
	  color: white;
	}
	.vShadow {
		-webkit-box-shadow: 0px 0px 6px -2px rgba(0,0,0,1);
		-moz-box-shadow: 0px 0px 6px -2px rgba(0,0,0,1);
		box-shadow: 0px 0px 6px -2px rgba(0,0,0,1);
	}
	.vLine{
		border-bottom: 0.055555em solid black;
		width: 100%; height: 0.1em;
		display: block;
	}
</style>

<!--------------------------------------------------------------------------------------------------------------------->
<!-- ! HTML !  -->
<!--------------->

<div class="vDynamicSideMargin">
	<div class="vCanvas">
		<div STYLE="text-align: center;">
			<a onclick="switchGerman()" href="javascript:void(0);">Deutsch</a>
			<a onclick="switchEnglish()" href="javascript:void(0);">English</a>
		</div>
		<div class="vWrapper">
			<div class="vInfo vShadow" id="infoField">
			</div>
		</div>
		<div class="vWrapper">
			<div style="width:70%; float:left; min-width:10em;">
				<select id="NodeSelector">
					<option value="https://mainnet.infura.io/v3/4e8efa5c183249169020ef5302bdb10e">
						Main Net (infura API)
					</option>
					<option value="https://rinkeby.infura.io/v3/4e8efa5c183249169020ef5302bdb10e">
						Rinkeby Test-Net (infura API)
					</option>
				</select>
				</br>
				<input id="AddressInput" placeholder="Your ethereum address"></input>
				<input id="ContractAddress" placeholder="Vote contract address"></input>
			</div>
			<div style="float:right;">
				<button onclick="connectToContract()" id="connectButton" class="vShadow">CONNECT</button></br>
				<button onclick="clearHistory()" id="clearButton" class="vShadow">CLEAR</button>
			</div>
		</div>
		<div class="vWrapper">
			<b id="historyLabel">History:</b></br>
			<div id="InfoBox" class="vLog vShadow"></div>
		</div>
	</div>
</div>

<!--------------------------------------------------------------------------------------------------------------------->
<!-- ! CODE !  -->
<!--------------->

<script src="https://cdn.jsdelivr.net/npm/web3@1.2.6/dist/web3.min.js"></script>
<script>

	let lang = "en"

	window.onload = function() {
		if ( lang === "en" ) switchEnglish();
		else switchGerman();
	};

	function log(m){ document.getElementById("InfoBox").innerHTML += ('</br><div class="vInfo vShadow">'+String(m).replace("\n", "</br>")+'</div>'); }
	function logLine(){ document.getElementById("InfoBox").innerHTML += '</br><span class="vLine"></span>'; }
	function clearHistory(){document.getElementById("InfoBox").innerHTML="";}

	function switchEnglish()
	{
		lang = "en"
		document.getElementById("historyLabel").innerText = "History";
		document.getElementById("infoField").innerHTML = 
			"Info:".bold()+
			"</br></br>"+
				"Welcome to the FH-Voting Blockchain Interface!"+
			"</br></br>"+
				"In the Dropdown-Menu below, you may choose which Blockchain-Network you wish to connect to. The options are either our Main Network, or the Test-Network based on Rinkeby."+
			"</br></br>"+
				"In the next field, enter the ethereum address which has been assigned to you. This is your identity with which you will cast your vote. "+
			"</br></br>"+
				"The last field takes the address of the Voting-Contract. This address can be found below, make sure you verify that it is indeed correct!"+
			"</br></br>"+
			"Contract Addresses:".bold()+
			"</br></br>"+ "0x60a7B9353086D670F6459218e377F6C31B1d43DC"+"<br>";

		document.getElementById("connectButton").textContent = "CONNECT";
		document.getElementById("clearButton").textContent = "CLEAR";
		document.getElementById("AddressInput").placeholder = "Your ethereum address";
		document.getElementById("ContractAddress").placeholder = "Vote contract address";
	}

	function switchGerman()
	{
		lang = "de"
		document.getElementById("historyLabel").innerText = "Verlauf";
		document.getElementById("infoField").innerHTML = 
			"Info:".bold()+
			"</br></br>"+
				"Wilkommen im FH-Voting Blockchain Interface!"+
			"</br></br>"+
				"Im Menü unterhalb wählen Sie, auf welcher Blockchain Sie abstimmen möchten. Die Optionen sind entweder das Hauptnetzwerk, oder das Rinkeby-Testnetzwerk."+
			"</br></br>"+
				"Darunter geben Sie die Ihnen zugeteilte Ethereum-Adresse ein. Diese repräsentiert Ihre Identität mit welcher Sie Ihre Stimme abgeben."+
			"</br></br>"+
				"Im letzten Feld geben Sie die Adresse des Wahl-Contracts ein, bitte überprüfen Sie dessen Richtigkeit!"+
			"</br></br>"+
			"Contract Adressen:".bold()+
			"</br></br>"+ "0x60a7B9353086D670F6459218e377F6C31B1d43DC"+"<br>";
		
		document.getElementById("connectButton").textContent = "VERBINDEN";
		document.getElementById("clearButton").textContent = "VERLAUF LÖSCHEN";
		document.getElementById("AddressInput").placeholder = "Ihre Ethereum Adresse";
		document.getElementById("ContractAddress").placeholder = "Wahl-Contract Adresse";
	}

	function _l(versions){
		switch(lang) {
			case "en": return versions[0]
			case "de": return versions[1]
		}
	}

	// Backend :

	let _contract = null;
	let _web3 = null;
	let _administrator = null;
	let _user = null;
	let _userIsAdmin = false;

	function connectToContract()
	{
		var errorOccurred = false;
		if(document.getElementById("ContractAddress").value.trim()===""){
			log(`
			<b style="color: #A00000">
				`+_l([
						"ERROR! Please enter the voting contract address!",
						"FEHLER! Bitte geben Sie die Contract-Adresse ein."
				])+`
			</b></br>
			`)
			errorOccurred = true;
		}
		if (document.getElementById("AddressInput").value.trim()==="") {
			log(`
			<b style="color: #A00000">
				`+_l([
						"ERROR! Please enter your address!",
						"FEHLER! Bitte geben Sie Ihre Ethereum-Adresse ein."
					])+`
			</b></br>
			`)
			errorOccurred = true;
		}

		_web3 = getWeb3Connection();

		try {
			_contract = new web3.eth.Contract(ABI, document.getElementById("ContractAddress").value.trim());// Takes API and address
		} catch (e) {
			log(`
			<b style="color: #A00000">
				`+_l([
				"ERROR! Failed to connect to contract!</br>Message :</br> '"+e+"'",
				"Fehler! Verbindung zum Contract ist fehlgeschlagen!</br>Nachricht :</br> '"+e+"'"
			])+`
			</b></br>
			`);
			errorOccurred = true;
		}
		if ( _contract != null && !errorOccurred ) {
			log(_l([
				"Connection established successfully!",
				"Verbindung erfolgreich hergestellt!"
			]))
		}


		_contract.methods.administrator().call()
			.then( val => {
				_administrator = val;
				_user = document.getElementById("AddressInput").value.trim();
				_userIsAdmin = _user === _administrator;
				if ( _userIsAdmin ) {
					log(_l([
						"Hello administrator!",
						"Hallo Administrator!"
					]));
				} else {
					log(_l([
						"The administrator of this contract is : "+_administrator,
						"Der Administrator dieses Contracts ist : "+_administrator
					]));
				}
				if (!errorOccurred) {

					//_contract.methods.parties().call( // WHY IS THIS NOT WORKING?
					//		"1",function(err,res) {
					//		log(res)
					//});
					_contract.methods.parties("1").call() // WHY IS THIS NOT WORKING?
					 	.then( val => log(val) )
					 	.catch( err => log(err.message) );

					log(`
							`+_l(["Your choice","Ihre Wahl:"])+`: </br>
							<div style="margin-right: 1em;">
								<select id = "PartySelector">
									<option value="p1">Party 1</option>
									<option value="p2">Party 2</option>
									<option value="p3">Party 3</option>
								</select>
								<button onclick="submitVote()" style="float: right;">`+_l(["SUBMIT VOTE", "ABSTIMMEN"])+`</button>
								<div class="vInfo">
									Party 1: ...blablabla...</br>
									Party 2: ...blablablabla...</br>
								</div>
							</div>
					`);
				}
			})
			.catch(
					err => {
						log(`
							<b style="color: #A00000">
							`+_l([
									"ERROR! Failed to fetch administrator address from contract!</br>Message :</br> '"+err.message+"'",
									"Fehler! Administrator Addresse nicht abrufbar!</br>Nachricht :</br> '"+err.message+"'"
								])+`
							</b></br>
						`);
					}
			);

	}
	
	function submitVote()
	{
		var selector = document.getElementById("PartySelector");
		var party = selector.options[selector.selectedIndex].value.trim();
		var partyString = selector.options[selector.selectedIndex].text.trim();
		var address = document.getElementById("AddressInput").value.trim();
		var verify = confirm(
				_l([
					"Casting your vote is final. Do you wish to vote for " + partyString + "?",
					"Ihre Stimme lässt sich hinterher nicht mehr ändern. Stimmen Sie für " + partyString + "?"
				])
		);

		if (!verify) { return; } // VERIFICATION!

		//log(_l(["...establishing contract connection...", "...Verbindung mit dem Contract wird hergestellt..."]));

		var contract = _contract; //new web3.eth.Contract(ABI, document.getElementById("ContractAddress").value.trim());// Takes API and address

		log(_l(["...sending vote...", "...Stimme wird abgegeben..."]));
		//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		contract.methods.vote(partyString)
		.send({
			from: address,
			//gas: 150000,
			//gasPrice: '3000000'
		},function(error, transactionHash){ log(error) }
		);
		// Check how many votes:
		log(_l(["Number of votes for your party:","Anzahl der Stimmen für Ihre Partei:"])+"<br>"+
				contract.methods.parties(partyString)
				.send({
					from: address,
					//gas: 1500000//,
					//gasPrice: '30000000000000'
				},function(error, transactionHash){ log(error) }
		));
		//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
		log(_l(["Success!", "Erfolg!"]));

	}
	
	function getWeb3Connection()
	{
		log(_l(["...getting web3.js instance...", "...web3.js Instanz wird aufbereitet..."]))
		var web3
		if(window.web3==="legacy"){
			log(_l([
					"WARNING: Legacy mode detected! Please switch to neweset MetaMask version!",
				"ACTHUNG: Sie befinden sich im Legacy-Modus! Bitte wechseln Sie zur neusten MetaMask Version!"
			]))
			var selector = document.getElementById("NodeSelector");
			var rpcURL = selector.options[selector.selectedIndex].value;
			web3 = new Web3(new Web3.providers.HttpProvider(rpcURL))
		} else {
			web3 = window.web3;
		}
		return web3;
	}

	window.addEventListener('load', async () => {
		if (window.ethereum) {// Modern dapp browsers...
			window.web3 = new Web3(ethereum);
			try { // Request account access if needed
				await ethereum.enable();// Acccounts now exposed
			} catch (error) {
				alert(_l([
						"Account access denied! :(",
						"Account Zugriff verwehrt! :("
				]));// User denied account access...
			}
		} else if (window.web3) {// Legacy :
			alert(_l([
					'Legacy browser detected. You should consider trying newest version of MetaMask!',
					'Veralteter Browser erkannt. Probieren Sie sie neuste MetaMask version!'
			]));
			window.web3 = "legacy"
		} else { // Full legacy : (Never go full legacy)
			alert(_l([
					'Non-Ethereum browser detected. You should consider trying MetaMask!',
					'Ethereum inkompatibler Browser erkannt! Probiern Sie MetaMask!'
			]));
		}
	});

</script>
		




